<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AICTE Approval & Compliance System</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
:root {
  --navy:#0a2240;--navy-light:#133568;--saffron:#FF6B00;--saffron-light:#FF8C38;
  --green-india:#138808;--gold:#C8A84B;--cream:#F8F5EE;--white:#FFFFFF;
  --gray-100:#F4F6F9;--gray-200:#E8ECF2;--gray-300:#D0D7E3;
  --gray-500:#7A8BA3;--gray-700:#3D4F6B;--red-flag:#D92B3A;
  --amber:#E8920A;--success:#1A8A4A;--border:#C8D0DC;
  --shadow:0 2px 16px rgba(10,34,64,.12);--shadow-lg:0 8px 40px rgba(10,34,64,.18);
  --sidebar-w:260px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans',sans-serif;background:var(--gray-100);color:var(--navy);font-size:14px}
h1,h2,h3,h4,h5{font-family:'Rajdhani',sans-serif;font-weight:700}
.screen{display:none}.screen.active{display:block}

/* === LANDING === */
#landing{min-height:100vh;background:linear-gradient(145deg,var(--navy) 0%,var(--navy-light) 60%,#1a4a8a 100%);display:flex;flex-direction:column}
.emblem-header{background:linear-gradient(90deg,var(--saffron) 0%,#FF8C38 50%,var(--saffron) 100%);padding:6px 24px;display:flex;align-items:center;gap:16px;font-size:11px;color:var(--white);font-weight:600;letter-spacing:.5px}
.tricolor-bar{height:5px;background:linear-gradient(90deg,var(--saffron) 33.3%,#fff 33.3% 66.6%,var(--green-india) 66.6%)}
.landing-nav{display:flex;align-items:center;justify-content:space-between;padding:20px 48px;border-bottom:1px solid rgba(255,255,255,.1)}
.logo-section{display:flex;align-items:center;gap:16px}
.emblem-circle{width:60px;height:60px;background:var(--white);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.logo-text h1{color:var(--white);font-size:22px;letter-spacing:1px}
.logo-text p{color:rgba(255,255,255,.7);font-size:11px;letter-spacing:2px}
.nav-btns{display:flex;gap:12px}
.btn{padding:10px 24px;border-radius:4px;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none;letter-spacing:.5px;transition:all .2s}
.btn-outline{background:transparent;border:2px solid rgba(255,255,255,.6);color:var(--white)}
.btn-outline:hover{background:rgba(255,255,255,.1);border-color:var(--white)}
.btn-saffron{background:var(--saffron);color:var(--white)}
.btn-saffron:hover{background:var(--saffron-light);transform:translateY(-1px);box-shadow:0 4px 16px rgba(255,107,0,.4)}
.btn-navy{background:var(--navy);color:var(--white)}
.btn-navy:hover{background:var(--navy-light)}
.btn-green{background:var(--green-india);color:var(--white)}
.btn-green:hover{background:#1aa00e}
.btn-sm{padding:7px 16px;font-size:13px}
.btn-block{width:100%}
.btn-red{background:var(--red-flag);color:var(--white)}
.landing-hero{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:60px 48px;text-align:center}
.landing-hero h2{color:var(--white);font-size:48px;letter-spacing:2px;line-height:1.1;margin-bottom:16px}
.landing-hero h2 span{color:var(--saffron)}
.landing-hero p{color:rgba(255,255,255,.75);font-size:16px;max-width:600px;line-height:1.7;margin-bottom:40px}
.portal-cards{display:flex;gap:24px;flex-wrap:wrap;justify-content:center}
.portal-card{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:32px 36px;text-align:center;width:280px;cursor:pointer;transition:all .3s;backdrop-filter:blur(10px)}
.portal-card:hover{background:rgba(255,255,255,.12);transform:translateY(-4px);border-color:var(--saffron);box-shadow:0 12px 40px rgba(0,0,0,.3)}
.portal-card .icon{font-size:48px;margin-bottom:16px}
.portal-card h3{color:var(--white);font-size:20px;margin-bottom:8px}
.portal-card p{color:rgba(255,255,255,.6);font-size:13px;line-height:1.6;margin-bottom:20px}
.stats-bar{background:rgba(0,0,0,.3);padding:20px 48px;display:flex;justify-content:space-around;flex-wrap:wrap;gap:12px}
.stat-item{text-align:center}
.stat-item .num{color:var(--saffron);font-family:'Rajdhani';font-size:28px;font-weight:700}
.stat-item .lbl{color:rgba(255,255,255,.6);font-size:11px;letter-spacing:1px}

/* === AUTH === */
.auth-page{min-height:100vh;background:linear-gradient(145deg,var(--navy) 0%,var(--navy-light) 100%);display:flex;align-items:center;justify-content:center;padding:40px 20px}
.auth-box{background:var(--white);border-radius:8px;width:480px;overflow:hidden;box-shadow:var(--shadow-lg)}
.auth-header{background:var(--navy);padding:24px 32px;display:flex;align-items:center;gap:14px}
.auth-header .icon{font-size:32px}
.auth-header h2{color:var(--white);font-size:18px}
.auth-header p{color:rgba(255,255,255,.6);font-size:12px}
.auth-body{padding:32px}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-weight:600;font-size:12px;letter-spacing:.5px;color:var(--gray-700);margin-bottom:6px;text-transform:uppercase}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:4px;font-size:14px;font-family:'Noto Sans';color:var(--navy);transition:border-color .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--saffron)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.auth-footer{padding:0 32px 24px;text-align:center;font-size:13px;color:var(--gray-500)}
.auth-footer a{color:var(--saffron);cursor:pointer;font-weight:600}
.back-link{display:flex;align-items:center;gap:8px;color:rgba(255,255,255,.7);cursor:pointer;font-size:13px;padding:16px 48px}
.back-link:hover{color:var(--white)}
.auth-tabs{display:flex;border-bottom:1px solid var(--border)}
.auth-tab{flex:1;text-align:center;padding:12px;font-family:'Rajdhani';font-weight:700;font-size:14px;cursor:pointer;color:var(--gray-500);border-bottom:2px solid transparent;transition:all .2s}
.auth-tab.active{color:var(--saffron);border-bottom-color:var(--saffron)}

/* === APP LAYOUT === */
#app{display:none;min-height:100vh}
#app.active{display:flex;flex-direction:column}
.top-bar{background:var(--navy);height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:fixed;top:0;left:0;right:0;z-index:100;border-bottom:3px solid var(--saffron)}
.top-bar-left{display:flex;align-items:center;gap:14px}
.top-logo{font-family:'Rajdhani';font-size:18px;color:var(--white);font-weight:700;letter-spacing:1px}
.top-logo span{color:var(--saffron)}
.role-badge{background:var(--saffron);color:var(--white);padding:3px 10px;border-radius:3px;font-size:11px;font-weight:700;letter-spacing:1px}
.role-badge.authority{background:var(--green-india)}
.top-bar-right{display:flex;align-items:center;gap:12px}
.top-icon{color:rgba(255,255,255,.7);cursor:pointer;font-size:18px;padding:6px;border-radius:4px;transition:all .2s}
.top-icon:hover{color:var(--white);background:rgba(255,255,255,.1)}
.user-pill{display:flex;align-items:center;gap:8px}
.user-avatar{width:32px;height:32px;border-radius:50%;background:var(--saffron);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--white);font-size:13px}
.user-name{color:rgba(255,255,255,.85);font-size:13px}
.app-body{display:flex;padding-top:56px}
.sidebar{width:var(--sidebar-w);background:var(--white);position:fixed;top:56px;left:0;bottom:0;overflow-y:auto;border-right:1px solid var(--border);z-index:90}
.sidebar-section{padding:16px 0;border-bottom:1px solid var(--gray-200)}
.sidebar-section-title{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--gray-500);padding:0 20px 8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 20px;cursor:pointer;font-size:14px;color:var(--gray-700);font-weight:500;transition:all .15s;border-left:3px solid transparent}
.nav-item:hover{background:var(--gray-100);color:var(--navy)}
.nav-item.active{background:#FFF5EE;color:var(--saffron);border-left-color:var(--saffron);font-weight:600}
.nav-item .ni{font-size:18px;width:22px;text-align:center}
.main-content{margin-left:var(--sidebar-w);flex:1;padding:24px}
.page{display:none}.page.active{display:block}

/* CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--white);border-radius:6px;padding:20px 24px;border:1px solid var(--border);position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.stat-card.blue::before{background:var(--navy)}.stat-card.orange::before{background:var(--saffron)}
.stat-card.green::before{background:var(--green-india)}.stat-card.red::before{background:var(--red-flag)}
.stat-card.gold::before{background:var(--gold)}.stat-card.amber::before{background:var(--amber)}
.stat-card .sc-label{font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--gray-500);margin-bottom:8px}
.stat-card .sc-value{font-family:'Rajdhani';font-size:36px;font-weight:700;color:var(--navy);line-height:1}
.stat-card .sc-sub{font-size:12px;color:var(--gray-500);margin-top:4px}
.stat-card .sc-icon{position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:36px;opacity:.1}
.card{background:var(--white);border-radius:6px;border:1px solid var(--border);margin-bottom:20px}
.card-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-header h3{font-size:16px;color:var(--navy)}
.card-body{padding:24px}.card-body-sm{padding:16px 24px}
.badge{display:inline-block;padding:3px 10px;border-radius:3px;font-size:11px;font-weight:700;letter-spacing:.5px}
.badge-approved{background:#D4EDDA;color:#155724}.badge-pending{background:#FFF3CD;color:#856404}
.badge-rejected{background:#F8D7DA;color:#721C24}.badge-flagged{background:#F8D7DA;color:#721C24}
.badge-low{background:#D4EDDA;color:#155724}.badge-medium{background:#FFF3CD;color:#856404}
.badge-high{background:#F8D7DA;color:#721C24}.badge-analyzed{background:#D4EDDA;color:#155724}
.data-table{width:100%;border-collapse:collapse}
.data-table th{background:var(--gray-100);text-align:left;padding:10px 14px;font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--gray-700);border-bottom:2px solid var(--border)}
.data-table td{padding:12px 14px;border-bottom:1px solid var(--gray-200);font-size:13px;vertical-align:middle}
.data-table tr:last-child td{border-bottom:none}
.data-table tr:hover td{background:var(--gray-100)}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
.chart-container{position:relative;height:240px}
.page-header{margin-bottom:24px}
.page-header h2{font-size:26px;color:var(--navy)}
.page-header p{color:var(--gray-500);font-size:13px;margin-top:4px}
.alert-banner{padding:12px 16px;border-radius:4px;display:flex;gap:10px;align-items:flex-start;margin-bottom:16px;font-size:13px}
.alert-banner.warn{background:#FFF3CD;border-left:4px solid var(--amber);color:#7d5a00}
.alert-banner.info{background:#E0ECFF;border-left:4px solid #1A5EBF;color:#0A3D9E}
.alert-banner.danger{background:#F8D7DA;border-left:4px solid var(--red-flag);color:#721c24}
.alert-banner.success{background:#D4EDDA;border-left:4px solid var(--green-india);color:#155724}
.notif-item{display:flex;gap:14px;padding:14px 0;border-bottom:1px solid var(--gray-200)}
.notif-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.notif-icon.warning{background:#FFF3CD}.notif-icon.success{background:#D4EDDA}
.notif-icon.danger{background:#F8D7DA}.notif-icon.info{background:#E0ECFF}
.notif-title{font-weight:600;font-size:13px;color:var(--navy);margin-bottom:3px}
.notif-desc{font-size:12px;color:var(--gray-500)}
.notif-time{font-size:11px;color:var(--gray-500);margin-top:4px}
.action-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--gray-200)}
.action-item:last-child{border-bottom:none}
.action-bullet{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}
.compliance-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.compliance-row .cr-label{width:200px;font-size:13px;font-weight:500}
.compliance-row .cr-bar{flex:1;height:10px;background:var(--gray-200);border-radius:5px;overflow:hidden}
.compliance-row .cr-fill{height:100%;border-radius:5px}
.compliance-row .cr-val{width:40px;text-align:right;font-size:12px;font-weight:700;color:var(--navy)}
.gov-footer{background:var(--navy);color:rgba(255,255,255,.6);padding:12px 24px;font-size:11px;display:flex;justify-content:space-between;align-items:center}
.gov-footer a{color:var(--saffron)}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--gray-100)}::-webkit-scrollbar-thumb{background:var(--gray-300);border-radius:3px}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--white);border-radius:8px;width:560px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--white);z-index:1}
.modal-header h3{font-size:18px}
.modal-close{cursor:pointer;font-size:20px;color:var(--gray-500)}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}

/* UPLOAD SECTION CARDS */
.upload-sections-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:24px}
.section-upload-card{background:var(--white);border:1px solid var(--border);border-radius:8px;padding:20px;position:relative;overflow:hidden;transition:all .2s}
.section-upload-card:hover{box-shadow:var(--shadow);border-color:var(--saffron)}
.section-upload-card.done{border-color:var(--green-india)}
.section-upload-card .su-icon{font-size:32px;margin-bottom:10px}
.section-upload-card h4{font-size:15px;margin-bottom:6px;font-family:'Rajdhani'}
.section-upload-card p{font-size:12px;color:var(--gray-500);margin-bottom:14px;line-height:1.5}
.section-upload-card .su-status{font-size:11px;font-weight:700;margin-bottom:12px}
.su-status.uploaded{color:var(--green-india)}.su-status.pending{color:var(--gray-500)}
.section-upload-card input[type=file]{display:none}
.upload-btn{background:var(--saffron);color:var(--white);border:none;padding:8px 18px;border-radius:4px;font-family:'Rajdhani';font-size:13px;font-weight:700;cursor:pointer;width:100%;letter-spacing:.5px}
.upload-btn:hover{background:var(--saffron-light)}
.upload-btn.done{background:var(--green-india)}
.upload-btn:disabled{background:var(--gray-300);cursor:not-allowed}

/* AI DATA DISPLAY TABLES */
.ai-data-table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
.ai-data-table th{background:var(--gray-100);padding:8px 12px;text-align:left;font-size:11px;font-weight:700;color:var(--gray-700);letter-spacing:.5px;border-bottom:1px solid var(--border)}
.ai-data-table td{padding:8px 12px;border-bottom:1px solid var(--gray-200)}

.risk-circle-wrap{text-align:center;padding:24px}
.risk-score-big{font-family:'Rajdhani';font-size:56px;font-weight:700;line-height:1}
.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-top-color:var(--white);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.spin-orange{border-color:rgba(255,107,0,.2);border-top-color:var(--saffron)}
</style>
</head>
<body>

<!-- ===== LANDING ===== -->
<div id="landing" class="screen active">
  <div class="tricolor-bar"></div>
  <div class="emblem-header">
    <span>üáÆüá≥</span>
    <span>GOVERNMENT OF INDIA ‚Äî MINISTRY OF EDUCATION</span>
    <span style="margin-left:auto">Screen Reader | ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä | Help</span>
  </div>
  <div class="landing-nav">
    <div class="logo-section">
      <div class="emblem-circle">‚öñÔ∏è</div>
      <div class="logo-text">
        <h1>AICTE PORTAL</h1>
        <p>ALL INDIA COUNCIL FOR TECHNICAL EDUCATION</p>
      </div>
    </div>
    <div class="nav-btns">
      <button class="btn btn-outline" onclick="showScreen('login')">Sign In</button>
      <button class="btn btn-saffron" onclick="showScreen('register')">Register Institution</button>
    </div>
  </div>
  <div class="landing-hero">
    <h2>AICTE <span>Approval</span> &<br>Compliance System</h2>
    <p>A unified digital platform for mandatory disclosures, AI-powered compliance monitoring, and authority review ‚Äî ensuring transparency in technical education.</p>
    <div class="portal-cards">
      <div class="portal-card" onclick="showScreen('login')">
        <div class="icon">üèõÔ∏è</div>
        <h3>Institution Portal</h3>
        <p>Register, upload mandatory disclosure PDFs, get AI risk analysis, and track compliance status.</p>
        <button class="btn btn-saffron btn-block">Login as Institution</button>
      </div>
      <div class="portal-card" onclick="showScreen('auth-login')">
        <div class="icon">üîç</div>
        <h3>Authority Portal</h3>
        <p>Review all institutions, view AI risk scores, monitor deficiencies, and generate reports.</p>
        <button class="btn btn-green btn-block">Login as Authority</button>
      </div>
    </div>
  </div>
  <div class="stats-bar">
    <div class="stat-item"><div class="num">11,200+</div><div class="lbl">Approved Institutions</div></div>
    <div class="stat-item"><div class="num">38</div><div class="lbl">States & UTs</div></div>
    <div class="stat-item"><div class="num">2.4L+</div><div class="lbl">Applications Processed</div></div>
    <div class="stat-item"><div class="num">98.2%</div><div class="lbl">Digital Compliance</div></div>
    <div class="stat-item"><div class="num">847</div><div class="lbl">AI Flags Resolved</div></div>
  </div>
</div>

<!-- ===== LOGIN ===== -->
<div id="login" class="screen">
  <div class="auth-page">
    <div style="width:480px">
      <div class="back-link" onclick="showScreen('landing')">‚Üê Back to Portal Home</div>
      <div class="auth-box">
        <div class="auth-header" id="loginHeader">
          <div class="icon">üîê</div>
          <div><h2>Institution Login</h2><p>AICTE Approval & Compliance System</p></div>
        </div>
        <div style="padding:0 32px 8px">
          <div class="auth-tabs">
            <div class="auth-tab active" id="tab-inst" onclick="switchTab('institution')">Institution</div>
            <div class="auth-tab" id="tab-auth" onclick="switchTab('authority')">Authority</div>
          </div>
        </div>
        <div class="auth-body">
          <div class="alert-banner info" id="loginInfo">‚ÑπÔ∏è Enter your registered email and password.</div>
          <div id="loginErr" class="alert-banner danger" style="display:none"></div>
          <div class="form-group">
            <label>Email ID</label>
            <input type="email" id="loginEmail" placeholder="principal@institution.ac.in">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <button class="btn btn-saffron btn-block" id="loginBtn" onclick="doLogin()">LOGIN ‚Üí</button>
        </div>
        <div class="auth-footer">New Institution? <a onclick="showScreen('register')">Register Here</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== AUTHORITY LOGIN ===== -->
<div id="auth-login" class="screen">
  <div class="auth-page">
    <div style="width:480px">
      <div class="back-link" onclick="showScreen('landing')">‚Üê Back to Portal Home</div>
      <div class="auth-box">
        <div class="auth-header" style="background:var(--green-india)">
          <div class="icon">üîç</div>
          <div><h2>Authority Login</h2><p>AICTE Regional Review System</p></div>
        </div>
        <div class="auth-body">
          <div class="alert-banner info">‚ÑπÔ∏è Demo: Use <b>reviewer@aicte-india.org</b> / <b>demo1234</b></div>
          <div id="authLoginErr" class="alert-banner danger" style="display:none"></div>
          <div class="form-group"><label>Official Email ID</label><input type="email" id="authEmail" value="reviewer@aicte-india.org"></div>
          <div class="form-group"><label>Password</label><input type="password" id="authPass" value="demo1234"></div>
          <button class="btn btn-green btn-block" id="authLoginBtn" onclick="doAuthorityLogin()">LOGIN ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== REGISTER ===== -->
<div id="register" class="screen">
  <div class="auth-page">
    <div style="width:640px">
      <div class="back-link" onclick="showScreen('landing')">‚Üê Back to Portal Home</div>
      <div class="auth-box" style="width:100%">
        <div class="auth-header">
          <div class="icon">üèõÔ∏è</div>
          <div><h2>Institution Registration</h2><p>Register your institution on AICTE Portal</p></div>
        </div>
        <div class="auth-body">
          <div id="regErr" class="alert-banner danger" style="display:none"></div>
          <div class="form-row">
            <div class="form-group"><label>Institution Name *</label><input id="regName" placeholder="e.g. NMIT Bengaluru"></div>
            <div class="form-group"><label>AICTE Institute ID</label><input id="regAicteId" placeholder="1-123456789"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Institution Type *</label>
              <select id="regType"><option>Engineering</option><option>Pharmacy</option><option>MBA/Management</option><option>Architecture</option><option>MCA</option></select>
            </div>
            <div class="form-group"><label>Category *</label>
              <select id="regCategory"><option>Affiliated</option><option>Autonomous</option><option>Deemed University</option><option>University</option></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Year of Establishment *</label><input id="regYear" type="number" placeholder="1998"></div>
            <div class="form-group"><label>Affiliated University *</label><input id="regUniv" placeholder="e.g. VTU"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>State *</label>
              <select id="regState"><option>Karnataka</option><option>Maharashtra</option><option>Tamil Nadu</option><option>Andhra Pradesh</option><option>Telangana</option><option>Gujarat</option><option>Kerala</option></select>
            </div>
            <div class="form-group"><label>District *</label><input id="regDistrict" placeholder="Enter district"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Pincode</label><input id="regPincode" placeholder="560001"></div>
            <div class="form-group"><label>Principal Name *</label><input id="regPrincipal" placeholder="Dr. Full Name"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Contact Email *</label><input id="regEmail" type="email" placeholder="principal@inst.ac.in"></div>
            <div class="form-group"><label>Mobile</label><input id="regMobile" placeholder="+91 XXXXXXXXXX"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Password *</label><input id="regPass" type="password" placeholder="Min 8 characters"></div>
            <div class="form-group"><label>Confirm Password *</label><input id="regCpass" type="password" placeholder="Re-enter password"></div>
          </div>
          <button class="btn btn-saffron btn-block" id="regBtn" onclick="doRegister()" style="margin-top:8px">SUBMIT REGISTRATION ‚Üí</button>
        </div>
        <div class="auth-footer">Already registered? <a onclick="showScreen('login')">Login Here</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="app">
  <div class="top-bar">
    <div class="top-bar-left">
      <div class="top-logo">‚öñÔ∏è AICTE <span>PORTAL</span></div>
      <div class="role-badge" id="roleBadge">INSTITUTION</div>
    </div>
    <div class="top-bar-right">
      <div class="top-icon" onclick="navTo('notifications')" title="Notifications">üîî</div>
      <div class="user-pill">
        <div class="user-avatar" id="userAvatarTop">?</div>
        <div class="user-name" id="userNameTop">Loading...</div>
      </div>
      <div class="top-icon" onclick="doLogout()" title="Logout">üö™</div>
    </div>
  </div>

  <div class="app-body">
    <!-- INSTITUTION SIDEBAR -->
    <div class="sidebar" id="inst-sidebar">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border)">
        <div style="font-size:11px;color:var(--gray-500);margin-bottom:4px">Logged in as</div>
        <div style="font-weight:700;color:var(--navy);font-size:14px" id="sidebarInstName">‚Äî</div>
        <div style="font-size:12px;color:var(--gray-500)" id="sidebarAicteId">‚Äî</div>
      </div>
      <div style="padding:12px">
        <div id="sidebarRiskCard" style="background:#FFF5EE;border:1px solid #FFD7B5;border-radius:6px;padding:12px;display:none">
          <div style="font-size:11px;font-weight:700;color:var(--saffron);margin-bottom:4px">‚ö° AI RISK SCORE</div>
          <div style="font-family:'Rajdhani';font-size:28px;font-weight:700;color:var(--amber)" id="sidebarRiskScore">‚Äî</div>
          <div style="font-size:11px;color:var(--gray-500)" id="sidebarRiskLevel">‚Äî</div>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">Main Menu</div>
        <div class="nav-item active" onclick="navTo('inst-dashboard')"><span class="ni">üìä</span> Dashboard</div>
        <div class="nav-item" onclick="navTo('upload-disclosures')"><span class="ni">üìÅ</span> Upload Disclosures</div>
        <div class="nav-item" onclick="navTo('my-disclosures')"><span class="ni">üìã</span> My Disclosures</div>
        <div class="nav-item" onclick="navTo('ai-risk')"><span class="ni">ü§ñ</span> AI Risk Report</div>
        <div class="nav-item" onclick="navTo('notifications')"><span class="ni">üîî</span> Notifications</div>
        <div class="nav-item" onclick="navTo('profile')"><span class="ni">üèõÔ∏è</span> Profile</div>
      </div>
    </div>

    <!-- AUTHORITY SIDEBAR -->
    <div class="sidebar" id="auth-sidebar" style="display:none">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border)">
        <div style="font-size:11px;color:var(--gray-500);margin-bottom:4px">Reviewer</div>
        <div style="font-weight:700;color:var(--navy);font-size:14px" id="authSidebarName">‚Äî</div>
        <div style="font-size:12px;color:var(--gray-500)">AICTE Authority Portal</div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">Authority Menu</div>
        <div class="nav-item active" onclick="navTo('auth-dashboard')"><span class="ni">üìä</span> Dashboard</div>
        <div class="nav-item" onclick="navTo('auth-institutions')"><span class="ni">üîç</span> All Institutions</div>
        <div class="nav-item" onclick="navTo('auth-analytics')"><span class="ni">üìà</span> Analytics</div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">

      <!-- ===== INSTITUTION DASHBOARD ===== -->
      <div class="page active" id="page-inst-dashboard">
        <div class="page-header">
          <h2>Institution Dashboard</h2>
          <p id="dashSubtitle">Loading your institution data...</p>
        </div>
        <div id="dashAlert" style="display:none"></div>
        <div class="stats-grid">
          <div class="stat-card blue"><div class="sc-label">Sections Uploaded</div><div class="sc-value" id="ds-uploads">0</div><div class="sc-sub">of 6 sections</div><div class="sc-icon">üìÅ</div></div>
          <div class="stat-card green"><div class="sc-label">Total Students</div><div class="sc-value" id="ds-students">‚Äî</div><div class="sc-sub">From PDF data</div><div class="sc-icon">üë®‚Äçüéì</div></div>
          <div class="stat-card orange"><div class="sc-label">Total Faculty</div><div class="sc-value" id="ds-faculty">‚Äî</div><div class="sc-sub">From PDF data</div><div class="sc-icon">üë®‚Äçüè´</div></div>
          <div class="stat-card gold"><div class="sc-label">Total Labs</div><div class="sc-value" id="ds-labs">‚Äî</div><div class="sc-sub">From PDF data</div><div class="sc-icon">üî¨</div></div>
          <div class="stat-card amber"><div class="sc-label">AI Risk Score</div><div class="sc-value" id="ds-risk">‚Äî</div><div class="sc-sub" id="ds-risk-level">Not Analyzed</div><div class="sc-icon">ü§ñ</div></div>
        </div>

        <!-- Compliance + Faculty -->
        <div class="charts-grid">
          <div class="card">
            <div class="card-header"><h3>Compliance Overview</h3></div>
            <div class="card-body" id="dashComplianceBody">
              <div style="color:var(--gray-500);font-size:13px">Upload disclosure PDFs to see compliance data.</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Infrastructure Summary</h3></div>
            <div class="card-body" id="dashInfraBody">
              <div style="color:var(--gray-500);font-size:13px">Upload infrastructure PDF to see details.</div>
            </div>
          </div>
        </div>

        <!-- Risk Factors -->
        <div class="card" id="dashRiskCard" style="display:none">
          <div class="card-header"><h3>ü§ñ AI Risk Factors</h3><span id="dashRiskBadge" class="badge"></span></div>
          <div class="card-body" id="dashRiskFactors"></div>
        </div>

        <!-- Suggestions -->
        <div class="card" id="dashSuggestCard" style="display:none">
          <div class="card-header"><h3>üí° Suggested Actions</h3></div>
          <div class="card-body" id="dashSuggestions"></div>
        </div>
      </div>

      <!-- ===== UPLOAD DISCLOSURES ===== -->
      <div class="page" id="page-upload-disclosures">
        <div class="page-header">
          <h2>Upload Mandatory Disclosures</h2>
          <p>Upload a PDF for each section. AI will extract data and update your compliance report automatically.</p>
        </div>
        <div class="alert-banner info">‚ÑπÔ∏è Upload PDFs section by section. Each PDF is analyzed by AI. Even empty/partial PDFs are accepted ‚Äî missing data uses defaults.</div>
        <div id="uploadProgress" style="display:none" class="alert-banner warn">‚è≥ Uploading and analyzing PDF... Please wait.</div>
        <div class="upload-sections-grid" id="uploadSectionsGrid">
          <!-- built by JS -->
        </div>
        <div class="card" id="uploadResultCard" style="display:none">
          <div class="card-header"><h3>‚úÖ Last Upload Result</h3></div>
          <div class="card-body" id="uploadResultBody"></div>
        </div>
      </div>

      <!-- ===== MY DISCLOSURES ===== -->
      <div class="page" id="page-my-disclosures">
        <div class="page-header">
          <h2>My Disclosures</h2>
          <p>All uploaded mandatory disclosure PDFs and extracted data.</p>
        </div>
        <div class="card">
          <div class="card-header"><h3>Uploaded Sections</h3><span class="badge badge-analyzed" id="discTotalBadge">0 Uploads</span></div>
          <div class="card-body-sm" id="disclosuresTableBody">
            <div style="color:var(--gray-500);text-align:center;padding:32px">No disclosures yet. Upload PDFs from the Upload Disclosures section.</div>
          </div>
        </div>
      </div>

      <!-- ===== AI RISK PAGE ===== -->
      <div class="page" id="page-ai-risk">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:center">
  <div>
    <h2>AI Risk & Compliance Report</h2>
    <p>AI-generated risk analysis based on your uploaded mandatory disclosure data.</p>
  </div>

  <button class="btn btn-navy btn-sm" onclick="downloadExcelReport()">
    üì• Download Excel Report
  </button>
</div>
        <div id="aiRiskContent">
          <div style="text-align:center;padding:60px;color:var(--gray-500)">
            <div style="font-size:48px;margin-bottom:16px">ü§ñ</div>
            <div style="font-size:18px;font-family:'Rajdhani';color:var(--navy);margin-bottom:8px">No Risk Analysis Yet</div>
            <div>Upload at least one mandatory disclosure PDF to generate AI risk report.</div>
          </div>
        </div>
      </div>

      <!-- ===== NOTIFICATIONS ===== -->
      <div class="page" id="page-notifications">
        <div class="page-header">
          <h2>Notifications</h2>
          <p>AICTE alerts and compliance notifications</p>
        </div>
        <div class="card">
          <div class="card-header"><h3>All Notifications</h3><span class="badge badge-flagged" id="notifUnreadBadge">0 Unread</span></div>
          <div class="card-body" id="notifBody">
            <div style="color:var(--gray-500);text-align:center;padding:32px">No notifications yet.</div>
          </div>
        </div>
      </div>

      <!-- ===== PROFILE ===== -->
      <div class="page" id="page-profile">
        <div class="page-header"><h2>Institution Profile</h2></div>
        <div class="card">
          <div class="card-header"><h3 id="profileName">‚Äî</h3></div>
          <div class="card-body">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px" id="profileBody">
              <div style="color:var(--gray-500)">Loading profile...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== AUTHORITY DASHBOARD ===== -->
      <div class="page" id="page-auth-dashboard">
        <div class="page-header">
          <h2>Authority Dashboard</h2>
          <p id="authDashSubtitle">All Institution Compliance Overview</p>
        </div>
        <div class="stats-grid">
          <div class="stat-card blue"><div class="sc-label">Total Institutions</div><div class="sc-value" id="ath-total">‚Äî</div><div class="sc-icon">üèõÔ∏è</div></div>
          <div class="stat-card gold"><div class="sc-label">Total Uploads</div><div class="sc-value" id="ath-uploads">‚Äî</div><div class="sc-icon">üìÅ</div></div>
          <div class="stat-card green"><div class="sc-label">Analyzed</div><div class="sc-value" id="ath-analyzed">‚Äî</div><div class="sc-icon">‚úÖ</div></div>
          <div class="stat-card red"><div class="sc-label">High Risk</div><div class="sc-value" id="ath-high">‚Äî</div><div class="sc-icon">üö©</div></div>
          <div class="stat-card amber"><div class="sc-label">Medium Risk</div><div class="sc-value" id="ath-medium">‚Äî</div><div class="sc-icon">‚ö†Ô∏è</div></div>
          <div class="stat-card green"><div class="sc-label">Low Risk</div><div class="sc-value" id="ath-low">‚Äî</div><div class="sc-icon">‚úÖ</div></div>
        </div>
        <div class="charts-grid">
          <div class="card">
            <div class="card-header"><h3>Risk Distribution</h3></div>
            <div class="card-body"><div class="chart-container"><canvas id="riskDistChart"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Institutions by State</h3></div>
            <div class="card-body"><div class="chart-container"><canvas id="stateChart"></canvas></div></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h3>üö® High Risk Institutions</h3></div>
          <div class="card-body-sm" id="authHighRiskBody">
            <div style="color:var(--gray-500);text-align:center;padding:20px">Loading...</div>
          </div>
        </div>
      </div>

      <!-- ===== AUTHORITY ALL INSTITUTIONS ===== -->
      <div class="page" id="page-auth-institutions">
        <div class="page-header">
          <h2>All Institutions</h2>
          <p>Complete list sorted by risk score</p>
        </div>
        <div style="display:flex;gap:12px;margin-bottom:16px">
          <input type="text" id="authSearch" onkeyup="filterAuthTable()" placeholder="üîç Search by name or state..." style="flex:1;padding:9px 14px;border:1.5px solid var(--border);border-radius:4px;font-size:13px">
          <select id="authRiskFilter" onchange="filterAuthTable()" style="padding:9px 14px;border:1.5px solid var(--border);border-radius:4px;font-size:13px">
            <option value="">All Risk Levels</option>
            <option value="High">High Risk</option>
            <option value="Medium">Medium Risk</option>
            <option value="Low">Low Risk</option>
            <option value="Not Analyzed">Not Analyzed</option>
          </select>
        </div>
        <div class="card">
          <div class="card-header"><h3>Institutions</h3><span class="badge badge-analyzed" id="authInstCount">0</span></div>
          <div class="card-body-sm" id="authInstBody">
            <div style="color:var(--gray-500);text-align:center;padding:32px">Loading...</div>
          </div>
        </div>
      </div>

      <!-- ===== AUTHORITY ANALYTICS ===== -->
      <div class="page" id="page-auth-analytics">
        <div class="page-header">
          <h2>Analytics & Monitoring</h2>
          <p>Region-wide compliance statistics</p>
        </div>
        <div class="charts-grid">
          <div class="card">
            <div class="card-header"><h3>Risk Distribution</h3></div>
            <div class="card-body"><div class="chart-container"><canvas id="analyticsRiskChart"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Institutions by State</h3></div>
            <div class="card-body"><div class="chart-container"><canvas id="analyticsStateChart"></canvas></div></div>
          </div>
        </div>
      </div>

    </div><!-- end main-content -->
  </div>

  <div class="gov-footer">
    <div>¬© 2025 All India Council for Technical Education | Ministry of Education</div>
    <div>Version 4.2.1 | <a>Terms of Use</a> | <a>Privacy Policy</a></div>
  </div>
</div>

<!-- FILE INPUT (hidden, reused) -->
<input type="file" id="hiddenFileInput" accept=".pdf" style="display:none" onchange="handleFileSelected(event)">

<script>
// ========================================================
//  CONFIG
// ========================================================
const API = 'https://api.chandus7.in/vvit';

// State
let currentRole = '';
let institutionId = 0;
let institutionName = '';
let currentUploadSection = '';
let allInstitutions = [];
let chartInstances = {};

const SECTION_DEFS = [
  { key:'faculty',        icon:'üë®‚Äçüè´', title:'Faculty Details',      desc:'Upload PDF containing faculty list, qualifications, designations, experience.' },
  { key:'labs',           icon:'üî¨', title:'Laboratory Details',    desc:'Upload PDF containing lab names, departments, area, equipment list.' },
  { key:'infrastructure', icon:'üè´', title:'Infrastructure',        desc:'Upload PDF with classrooms, library, computers, hostel, total area details.' },
  { key:'students',       icon:'üë®‚Äçüéì', title:'Student Details',      desc:'Upload PDF with enrollment data, UG/PG count, programs offered.' },
  { key:'financials',     icon:'üí∞', title:'Financial Details',     desc:'Upload PDF with annual budget, fee structure details.' },
  { key:'accreditation',  icon:'üéì', title:'Accreditation Details', desc:'Upload PDF with NAAC grade, NBA programs, ISO certification.' },
];

// Uploaded sections tracking
let uploadedSections = [];

// ========================================================
//  SCREEN NAVIGATION
// ========================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => { s.style.display='none'; s.classList.remove('active'); });
  document.getElementById('app').style.display = 'none';
  document.getElementById('app').classList.remove('active');
  const el = document.getElementById(id);
  if(el) { el.style.display='block'; el.classList.add('active'); }
  window.scrollTo(0,0);
}

function downloadExcelReport() {
  if(!institutionId) {
    showToast('Institution ID not found.', 'red');
    return;
  }

  const url = `${API}/download-excel/?institution_id=${institutionId}`;

  // Open in new tab ‚Üí triggers file download
  window.open(url, '_blank');
}

function switchTab(role) {
  if(role === 'authority') { showScreen('auth-login'); return; }
  document.getElementById('tab-inst').classList.add('active');
  document.getElementById('tab-auth').classList.remove('active');
}

// ========================================================
//  REGISTER
// ========================================================
async function doRegister() {
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pass = document.getElementById('regPass').value;
  const cpass = document.getElementById('regCpass').value;
  const errEl = document.getElementById('regErr');
  errEl.style.display='none';

  if(!name||!email||!pass) { showErr(errEl,'Institution name, email and password are required.'); return; }
  if(pass !== cpass) { showErr(errEl,'Passwords do not match.'); return; }
  if(pass.length < 6) { showErr(errEl,'Password must be at least 6 characters.'); return; }

  const btn = document.getElementById('regBtn');
  btn.disabled=true; btn.innerHTML='<span class="loading-spinner"></span> Registering...';

  try {
    const res = await fetch(`${API}/register/`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        institution_name: name,
        aicte_id: document.getElementById('regAicteId').value.trim(),
        inst_type: document.getElementById('regType').value,
        category: document.getElementById('regCategory').value,
        year_established: parseInt(document.getElementById('regYear').value)||2000,
        affiliated_univ: document.getElementById('regUniv').value.trim(),
        state: document.getElementById('regState').value,
        district: document.getElementById('regDistrict').value.trim(),
        pincode: document.getElementById('regPincode').value.trim(),
        principal_name: document.getElementById('regPrincipal').value.trim(),
        email: email,
        mobile: document.getElementById('regMobile').value.trim(),
        password: pass,
      })
    });
    const data = await res.json();
    if(!res.ok) { showErr(errEl, data.error || JSON.stringify(data)); return; }

    // Auto-login after register
    institutionId = data.institution_id;
    institutionName = data.institution_name;
    enterApp('institution');
  } catch(e) {
    showErr(errEl, 'Server error: '+e.message);
  } finally {
    btn.disabled=false; btn.textContent='SUBMIT REGISTRATION ‚Üí';
  }
}

// ========================================================
//  LOGIN
// ========================================================
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginErr');
  errEl.style.display='none';

  const btn = document.getElementById('loginBtn');
  btn.disabled=true; btn.innerHTML='<span class="loading-spinner"></span> Logging in...';

  try {
    const res = await fetch(`${API}/login/`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, password:pass})
    });
    const data = await res.json();
    if(!res.ok) { showErr(errEl, data.error||'Login failed'); return; }

    institutionId = data.institution_id;
    institutionName = data.institution_name;
    enterApp('institution');
  } catch(e) {
    showErr(errEl,'Server error: '+e.message);
  } finally {
    btn.disabled=false; btn.textContent='LOGIN ‚Üí';
  }
}

async function doAuthorityLogin() {
  const email = document.getElementById('authEmail').value.trim();
  const pass = document.getElementById('authPass').value;
  const errEl = document.getElementById('authLoginErr');
  errEl.style.display='none';

  const btn = document.getElementById('authLoginBtn');
  btn.disabled=true; btn.innerHTML='<span class="loading-spinner"></span> Logging in...';

  try {
    const res = await fetch(`${API}/authority/login/`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, password:pass})
    });
    const data = await res.json();
    if(!res.ok) { showErr(errEl, data.error||'Login failed'); return; }

    institutionName = data.name;
    enterApp('authority');
  } catch(e) {
    showErr(errEl,'Server error: '+e.message);
  } finally {
    btn.disabled=false; btn.textContent='LOGIN ‚Üí';
  }
}

// ========================================================
//  ENTER APP
// ========================================================
function enterApp(role) {
  currentRole = role;
  document.querySelectorAll('.screen').forEach(s => { s.style.display='none'; s.classList.remove('active'); });
  const app = document.getElementById('app');
  app.style.display = 'flex';
  app.classList.add('active');

  document.getElementById('userAvatarTop').textContent = (institutionName||'?')[0].toUpperCase();
  document.getElementById('userNameTop').textContent = institutionName;

  if(role === 'institution') {
    document.getElementById('inst-sidebar').style.display = 'block';
    document.getElementById('auth-sidebar').style.display = 'none';
    document.getElementById('roleBadge').textContent = 'INSTITUTION';
    document.getElementById('roleBadge').className = 'role-badge';
    document.getElementById('sidebarInstName').textContent = institutionName;
    navTo('inst-dashboard');
    loadDashboard();
  } else {
    document.getElementById('inst-sidebar').style.display = 'none';
    document.getElementById('auth-sidebar').style.display = 'block';
    document.getElementById('roleBadge').textContent = 'AUTHORITY';
    document.getElementById('roleBadge').className = 'role-badge authority';
    document.getElementById('authSidebarName').textContent = institutionName;
    navTo('auth-dashboard');
    loadAuthorityData();
  }
}

// ========================================================
//  NAVIGATION
// ========================================================
function navTo(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-'+page);
  if(el) el.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => {
    if(n.getAttribute('onclick') && n.getAttribute('onclick').includes("'"+page+"'")) n.classList.add('active');
  });
  // Load data per page
  if(page==='inst-dashboard') loadDashboard();
  else if(page==='upload-disclosures') buildUploadGrid();
  else if(page==='my-disclosures') loadDisclosures();
  else if(page==='ai-risk') loadAIRisk();
  else if(page==='notifications') loadNotifications();
  else if(page==='profile') loadProfile();
  else if(page==='auth-dashboard') loadAuthorityData();
  else if(page==='auth-institutions') renderAuthInstitutions();
  else if(page==='auth-analytics') renderAuthAnalytics();
}

function doLogout() {
  institutionId = 0; institutionName = ''; currentRole = '';
  uploadedSections = []; allInstitutions = [];
  Object.values(chartInstances).forEach(c => { if(c) c.destroy(); });
  chartInstances = {};
  document.getElementById('app').style.display = 'none';
  showScreen('landing');
}

// ========================================================
//  DASHBOARD
// ========================================================
async function loadDashboard() {
  if(!institutionId) return;
  try {
    const res = await fetch(`${API}/dashboard/?institution_id=${institutionId}`);
    if(!res.ok) return;
    const d = await res.json();
    uploadedSections = d.sections_uploaded || [];

    document.getElementById('dashSubtitle').textContent = d.institution_name + ' ‚Äî ' + d.aicte_id;
    document.getElementById('ds-uploads').textContent = uploadedSections.length;
    document.getElementById('ds-students').textContent = d.inst_data?.total_students || '‚Äî';
    document.getElementById('ds-faculty').textContent = d.inst_data?.total_faculty || '‚Äî';
    document.getElementById('ds-labs').textContent = d.inst_data?.total_labs || '‚Äî';
    document.getElementById('ds-risk').textContent = d.risk_score > 0 ? d.risk_score+'/100' : '‚Äî';
    document.getElementById('ds-risk-level').textContent = d.risk_level || 'Not Analyzed';
    document.getElementById('sidebarAicteId').textContent = 'AICTE ID: '+(d.aicte_id||'‚Äî');

    // Sidebar risk card
    if(d.risk_score > 0) {
      document.getElementById('sidebarRiskCard').style.display='block';
      document.getElementById('sidebarRiskScore').textContent = d.risk_score+'/100';
      document.getElementById('sidebarRiskLevel').textContent = d.risk_level;
    }

    // Alert banner
    const dashAlert = document.getElementById('dashAlert');
    if(d.risk_level === 'High') {
      dashAlert.style.display='flex';
      dashAlert.className='alert-banner danger';
      dashAlert.textContent='üî¥ High Risk Detected! '+((d.risk_factors||[])[0]||'');
    } else if(d.risk_level === 'Medium') {
      dashAlert.style.display='flex';
      dashAlert.className='alert-banner warn';
      dashAlert.textContent='‚ö†Ô∏è Medium Risk: '+((d.risk_factors||[])[0]||'');
    } else {
      dashAlert.style.display='none';
    }

    // Compliance bars
    const compEl = document.getElementById('dashComplianceBody');
    if(d.risk_score > 0) {
      const compPct = d.compliance_pct || 0;
      const facultyPct = d.faculty_shortage ? 40 : 80;
      const infraPct = d.infra_deficit ? 45 : 75;
      compEl.innerHTML = [
        ['Overall Compliance', compPct, compPct >= 70 ? 'var(--green-india)' : compPct >= 40 ? 'var(--amber)' : 'var(--red-flag)'],
        ['Faculty Status', facultyPct, facultyPct >= 70 ? 'var(--green-india)' : 'var(--amber)'],
        ['Infrastructure', infraPct, infraPct >= 70 ? 'var(--green-india)' : 'var(--amber)'],
      ].map(([lbl,val,clr]) => `
        <div class="compliance-row">
          <div class="cr-label">${lbl}</div>
          <div class="cr-bar"><div class="cr-fill" style="width:${val}%;background:${clr}"></div></div>
          <div class="cr-val">${Math.round(val)}%</div>
        </div>
      `).join('');
    }

    // Infra summary
    const infraEl = document.getElementById('dashInfraBody');
    const id = d.inst_data || {};
    if(id.total_students > 0 || id.total_faculty > 0) {
      infraEl.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          ${[['üë®‚Äçüè´','Faculty',id.total_faculty],['üë®‚Äçüéì','Students',id.total_students],
             ['üî¨','Labs',id.total_labs],['üè´','Classrooms',id.total_classrooms],
             ['üìö','Library Books',id.library_books],['üíª','Computers',id.computer_count]]
            .map(([ico,lbl,val]) => `
              <div style="background:var(--gray-100);border-radius:6px;padding:10px;display:flex;align-items:center;gap:8px">
                <span style="font-size:20px">${ico}</span>
                <div><div style="font-size:10px;color:var(--gray-500)">${lbl}</div>
                <div style="font-family:'Rajdhani';font-size:22px;font-weight:700;color:var(--navy)">${val||'‚Äî'}</div></div>
              </div>`).join('')}
        </div>
      `;
    }

    // Risk factors
    const rf = d.risk_factors || [];
    if(rf.length > 0) {
      document.getElementById('dashRiskCard').style.display='block';
      const badge = document.getElementById('dashRiskBadge');
      badge.textContent = d.risk_level;
      badge.className = 'badge badge-'+d.risk_level.toLowerCase();
      document.getElementById('dashRiskFactors').innerHTML = rf.map(f =>
        `<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--gray-200)">
          <span>‚ö†Ô∏è</span><span style="font-size:13px;color:var(--gray-700)">${f}</span>
        </div>`).join('');
    }
    const sg = d.suggestions || [];
    if(sg.length > 0) {
      document.getElementById('dashSuggestCard').style.display='block';
      document.getElementById('dashSuggestions').innerHTML = sg.map(s =>
        `<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--gray-200)">
          <span>‚Üí</span><span style="font-size:13px;color:var(--navy)">${s}</span>
        </div>`).join('');
    }

  } catch(e) { console.error('Dashboard error:', e); }
}

// ========================================================
//  UPLOAD DISCLOSURES
// ========================================================
function buildUploadGrid() {
  const grid = document.getElementById('uploadSectionsGrid');
  grid.innerHTML = SECTION_DEFS.map(sec => {
    const done = uploadedSections.includes(sec.key);
    return `
      <div class="section-upload-card ${done?'done':''}" id="sucard-${sec.key}">
        <div class="su-icon">${sec.icon}</div>
        <h4>${sec.title}</h4>
        <p>${sec.desc}</p>
        <div class="su-status ${done?'uploaded':'pending'}" id="sustatus-${sec.key}">
          ${done ? '‚úÖ Uploaded & Analyzed' : '‚¨ú Not uploaded yet'}
        </div>
        <button class="upload-btn ${done?'done':''}" id="subtn-${sec.key}"
          onclick="triggerUpload('${sec.key}')">
          ${done ? 'üîÑ Re-upload' : 'üì§ Upload PDF'}
        </button>
      </div>
    `;
  }).join('');
}

function triggerUpload(sectionKey) {
  currentUploadSection = sectionKey;
  document.getElementById('hiddenFileInput').value = '';
  document.getElementById('hiddenFileInput').click();
}

async function handleFileSelected(event) {
  const file = event.target.files[0];
  if(!file || !currentUploadSection) return;

  const progress = document.getElementById('uploadProgress');
  const resultCard = document.getElementById('uploadResultCard');
  const btn = document.getElementById(`subtn-${currentUploadSection}`);

  progress.style.display='flex';
  progress.textContent = `‚è≥ Uploading "${file.name}" for ${currentUploadSection}... AI is analyzing, please wait.`;
  resultCard.style.display='none';
  if(btn) { btn.disabled=true; btn.textContent='Analyzing...'; }

  const formData = new FormData();
  formData.append('institution_id', institutionId);
  formData.append('section_type', currentUploadSection);
  formData.append('academic_year', '2024-25');
  formData.append('pdf_file', file);

  try {
    const res = await fetch(`${API}/upload/`, { method:'POST', body:formData });
    const data = await res.json();
    progress.style.display='none';

    if(!res.ok) {
      showToast('Upload failed: '+(data.error||JSON.stringify(data)), 'red');
      if(btn) { btn.disabled=false; btn.textContent='üì§ Upload PDF'; }
      return;
    }

    // Mark as uploaded
    if(!uploadedSections.includes(currentUploadSection)) uploadedSections.push(currentUploadSection);

    // Update card
    const card = document.getElementById(`sucard-${currentUploadSection}`);
    if(card) card.classList.add('done');
    const status = document.getElementById(`sustatus-${currentUploadSection}`);
    if(status) { status.textContent='‚úÖ Uploaded & Analyzed'; status.className='su-status uploaded'; }
    if(btn) { btn.textContent='üîÑ Re-upload'; btn.className='upload-btn done'; btn.disabled=false; }

    // Show result
    resultCard.style.display='block';
    document.getElementById('uploadResultBody').innerHTML = buildUploadResult(data);

    showToast('‚úÖ '+currentUploadSection+' PDF analyzed successfully!', 'green');
    // Refresh dashboard data silently
    loadDashboard();

  } catch(e) {
    progress.style.display='none';
    showToast('Server error: '+e.message, 'red');
    if(btn) { btn.disabled=false; btn.textContent='üì§ Upload PDF'; }
  }
}

function buildUploadResult(data) {
  const aiData = data.ai_data || {};
  const risk = data.risk || {};
  const sec = data.section_type;

  let rows = '';
  if(sec==='faculty') {
    rows = `<tr><td>Total Faculty</td><td><b>${aiData.total_faculty||0}</b></td></tr>
            <tr><td>Required Faculty</td><td>${aiData.required_faculty||0}</td></tr>
            <tr><td>PhD Count</td><td>${aiData.faculty_phd_count||0}</td></tr>`;
    if((aiData.faculty_details||[]).length > 0) {
      rows += `<tr><td colspan="2"><b>Faculty List (${aiData.faculty_details.length} records)</b></td></tr>`;
      aiData.faculty_details.slice(0,5).forEach(f => {
        rows += `<tr><td>${f.name||'‚Äî'} (${f.dept||'‚Äî'})</td><td>${f.qualification||'‚Äî'}, ${f.experience_years||0} yrs</td></tr>`;
      });
    }
  } else if(sec==='labs') {
    rows = `<tr><td>Total Labs</td><td><b>${aiData.total_labs||0}</b></td></tr>`;
    (aiData.lab_details||[]).slice(0,5).forEach(l => {
      rows += `<tr><td>${l.name||'‚Äî'} (${l.dept||'‚Äî'})</td><td>${l.area_sqft||0} sqft, ${l.equipment_count||0} equipment</td></tr>`;
    });
  } else if(sec==='infrastructure') {
    rows = `<tr><td>Classrooms</td><td>${aiData.total_classrooms||0}</td></tr>
            <tr><td>Library Books</td><td>${aiData.library_books||0}</td></tr>
            <tr><td>Computers</td><td>${aiData.computer_count||0}</td></tr>
            <tr><td>Total Area (sqft)</td><td>${aiData.total_area_sqft||0}</td></tr>
            <tr><td>Hostel Capacity</td><td>${aiData.hostel_capacity||0}</td></tr>`;
  } else if(sec==='students') {
    rows = `<tr><td>Total Students</td><td><b>${aiData.total_students||0}</b></td></tr>
            <tr><td>UG Students</td><td>${aiData.ug_students||0}</td></tr>
            <tr><td>PG Students</td><td>${aiData.pg_students||0}</td></tr>
            <tr><td>Programs Offered</td><td>${(aiData.programs_offered||[]).join(', ')||'‚Äî'}</td></tr>`;
  } else if(sec==='financials') {
    rows = `<tr><td>Annual Budget</td><td>‚Çπ${aiData.annual_budget||0} Lakhs</td></tr>
            <tr><td>UG Fee</td><td>${aiData.fee_structure?.ug_fee||0}</td></tr>
            <tr><td>PG Fee</td><td>${aiData.fee_structure?.pg_fee||0}</td></tr>`;
  } else if(sec==='accreditation') {
    rows = `<tr><td>NAAC Grade</td><td>${aiData.naac_grade||'‚Äî'}</td></tr>
            <tr><td>NBA Programs</td><td>${aiData.nba_programs||'‚Äî'}</td></tr>
            <tr><td>ISO Certified</td><td>${aiData.iso_certified?'Yes':'No'}</td></tr>`;
  }

  return `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <b style="font-family:'Rajdhani';font-size:14px">üìä Extracted Data ‚Äî ${sec.toUpperCase()}</b>
        <table class="ai-data-table" style="margin-top:8px">
          <thead><tr><th>Field</th><th>Value</th></tr></thead>
          <tbody>${rows||'<tr><td colspan="2" style="color:var(--gray-500)">No data extracted ‚Äî defaults applied</td></tr>'}</tbody>
        </table>
      </div>
      <div>
        <b style="font-family:'Rajdhani';font-size:14px">ü§ñ Updated Risk Score</b>
        <div style="margin-top:12px;text-align:center">
          <div class="risk-score-big" style="color:${risk.risk_score>=70?'var(--red-flag)':risk.risk_score>=40?'var(--amber)':'var(--green-india)'}">${risk.risk_score||0}</div>
          <div style="font-size:12px;color:var(--gray-500)">/100</div>
          <div class="badge badge-${(risk.risk_level||'low').toLowerCase()}" style="margin-top:8px;font-size:13px;padding:6px 14px">${risk.risk_level||'Low'}</div>
        </div>
        ${(risk.risk_factors||[]).length > 0 ? `
          <div style="margin-top:12px">
            ${risk.risk_factors.map(f=>`<div style="font-size:12px;color:var(--gray-700);padding:4px 0;border-bottom:1px solid var(--gray-200)">‚ö†Ô∏è ${f}</div>`).join('')}
          </div>` : ''}
      </div>
    </div>
  `;
}

// ========================================================
//  MY DISCLOSURES
// ========================================================
async function loadDisclosures() {
  if(!institutionId) return;
  const body = document.getElementById('disclosuresTableBody');
  body.innerHTML = '<div style="padding:20px;color:var(--gray-500)">Loading...</div>';
  try {
    const res = await fetch(`${API}/disclosures/?institution_id=${institutionId}`);
    const data = await res.json();
    document.getElementById('discTotalBadge').textContent = data.length + ' Uploads';
    if(!data.length) {
      body.innerHTML = '<div style="color:var(--gray-500);text-align:center;padding:32px">No disclosures uploaded yet.</div>';
      return;
    }
    body.innerHTML = `
      <table class="data-table">
        <thead><tr><th>Section</th><th>Academic Year</th><th>Status</th><th>Risk</th><th>Uploaded</th><th>Key Data</th></tr></thead>
        <tbody>${data.map(d => {
          const ai = d.ai_data || {};
          let keyData = '';
          if(d.section_type==='faculty') keyData = `Faculty: ${ai.total_faculty||0}, PhD: ${ai.faculty_phd_count||0}`;
          else if(d.section_type==='labs') keyData = `Labs: ${ai.total_labs||0}`;
          else if(d.section_type==='students') keyData = `Students: ${ai.total_students||0}`;
          else if(d.section_type==='infrastructure') keyData = `Classrooms: ${ai.total_classrooms||0}, Library: ${ai.library_books||0}`;
          else if(d.section_type==='financials') keyData = `Budget: ‚Çπ${ai.annual_budget||0}L`;
          else if(d.section_type==='accreditation') keyData = `NAAC: ${ai.naac_grade||'‚Äî'}`;
          const riskBadge = d.risk ? `<span class="badge badge-${(d.risk.level||'low').toLowerCase()}">${d.risk.level} (${d.risk.score})</span>` : '<span class="badge">N/A</span>';
          return `<tr>
            <td><b>${d.section_type.toUpperCase()}</b></td>
            <td>${d.academic_year}</td>
            <td><span class="badge badge-analyzed">${d.status}</span></td>
            <td>${riskBadge}</td>
            <td style="font-size:12px;color:var(--gray-500)">${d.uploaded_at}</td>
            <td style="font-size:12px">${keyData}</td>
          </tr>`;
        }).join('')}</tbody>
      </table>`;
  } catch(e) { body.innerHTML = '<div style="color:var(--red-flag);padding:20px">Error loading disclosures.</div>'; }
}

// ========================================================
//  AI RISK PAGE
// ========================================================
async function loadAIRisk() {
  if(!institutionId) return;
  const container = document.getElementById('aiRiskContent');
  container.innerHTML = '<div style="text-align:center;padding:40px"><div class="loading-spinner spin-orange" style="width:36px;height:36px;border-width:4px"></div></div>';
  try {
    const res = await fetch(`${API}/ai-risk/?institution_id=${institutionId}`);
    if(res.status===404) {
      container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--gray-500)">
        <div style="font-size:48px;margin-bottom:16px">ü§ñ</div>
        <div style="font-size:18px;font-family:'Rajdhani';color:var(--navy);margin-bottom:8px">No Risk Analysis Yet</div>
        <div>Upload at least one mandatory disclosure PDF to generate AI risk report.</div>
      </div>`;
      return;
    }
    const d = await res.json();
    const clr = d.risk_score>=70?'var(--red-flag)':d.risk_score>=40?'var(--amber)':'var(--green-india)';
    const lvlClass = (d.risk_level||'low').toLowerCase();

    container.innerHTML = `
      <div style="display:grid;grid-template-columns:280px 1fr;gap:20px;margin-bottom:20px">
        <div class="card">
          <div class="card-header"><h3>Risk Score</h3></div>
          <div class="card-body risk-circle-wrap">
            <div class="risk-score-big" style="color:${clr}">${d.risk_score}</div>
            <div style="font-size:12px;color:var(--gray-500);margin-bottom:12px">/ 100</div>
            <span class="badge badge-${lvlClass}" style="font-size:14px;padding:6px 16px">${d.risk_level}</span>
            <div style="margin-top:16px;font-size:12px;color:var(--gray-500)">Compliance: <b>${Math.round(d.compliance_pct)}%</b></div>
            <div style="font-size:12px;color:var(--gray-500)">Faculty Ratio: <b>1:${d.faculty_ratio>0?Math.round(d.faculty_ratio):'N/A'}</b></div>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:16px">
            <div class="card-header"><h3>Risk Flags</h3></div>
            <div class="card-body">
              ${[['Faculty Shortage',d.faculty_shortage],['Infrastructure Deficit',d.infra_deficit],['Expired Certificates',d.expired_certs]]
                .map(([lbl,flag])=>`
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--gray-200)">
                  <span style="font-size:13px">${lbl}</span>
                  <span class="badge ${flag?'badge-flagged':'badge-approved'}">${flag?'‚ö†Ô∏è Issue Found':'‚úÖ OK'}</span>
                </div>`).join('')}
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Compliance Breakdown</h3></div>
            <div class="card-body">
              ${[['Overall Compliance',d.compliance_pct,'var(--green-india)'],
                 ['Faculty Status',d.faculty_shortage?35:80,d.faculty_shortage?'var(--red-flag)':'var(--green-india)'],
                 ['Infrastructure',d.infra_deficit?40:75,d.infra_deficit?'var(--amber)':'var(--green-india)'],
                 ['Certifications',d.expired_certs?25:85,d.expired_certs?'var(--red-flag)':'var(--green-india)']]
                .map(([lbl,val,clr])=>`
                <div class="compliance-row">
                  <div class="cr-label">${lbl}</div>
                  <div class="cr-bar"><div class="cr-fill" style="width:${Math.round(val)}%;background:${clr}"></div></div>
                  <div class="cr-val">${Math.round(val)}%</div>
                </div>`).join('')}
            </div>
          </div>
        </div>
      </div>

      ${(d.risk_factors||[]).length>0?`
      <div class="card">
        <div class="card-header"><h3>‚ö†Ô∏è Risk Factors</h3></div>
        <div class="card-body">
          ${d.risk_factors.map(f=>`<div class="action-item"><div class="action-bullet" style="background:var(--red-flag)"></div>
            <div style="font-size:13px;color:var(--gray-700)">${f}</div></div>`).join('')}
        </div>
      </div>`:''}

      ${(d.suggestions||[]).length>0?`
      <div class="card">
        <div class="card-header"><h3>üí° Suggested Actions</h3></div>
        <div class="card-body">
          ${d.suggestions.map(s=>`<div class="action-item"><div class="action-bullet" style="background:var(--green-india)"></div>
            <div style="font-size:13px;color:var(--navy)">${s}</div></div>`).join('')}
        </div>
      </div>`:''}

      ${(d.history||[]).length>0?`
      <div class="card">
        <div class="card-header"><h3>üìÖ Analysis History</h3></div>
        <div class="card-body-sm">
          <table class="data-table">
            <thead><tr><th>Section</th><th>Risk Score</th><th>Level</th><th>Date</th></tr></thead>
            <tbody>${d.history.map(h=>`<tr>
              <td>${h.section_type.toUpperCase()}</td>
              <td><b>${h.risk_score}/100</b></td>
              <td><span class="badge badge-${h.risk_level.toLowerCase()}">${h.risk_level}</span></td>
              <td style="font-size:12px;color:var(--gray-500)">${h.analyzed_at}</td>
            </tr>`).join('')}</tbody>
          </table>
        </div>
      </div>`:''}
    `;
  } catch(e) {
    container.innerHTML = '<div style="color:var(--red-flag);padding:20px">Error loading risk analysis.</div>';
  }
}

// ========================================================
//  NOTIFICATIONS
// ========================================================
async function loadNotifications() {
  if(!institutionId) return;
  const body = document.getElementById('notifBody');
  try {
    const res = await fetch(`${API}/notifications/?institution_id=${institutionId}`);
    const data = await res.json();
    const unread = data.filter(n=>!n.is_read).length;
    document.getElementById('notifUnreadBadge').textContent = unread + ' Unread';
    if(!data.length) { body.innerHTML='<div style="color:var(--gray-500);text-align:center;padding:32px">No notifications yet.</div>'; return; }
    const icons = {warning:'‚ö†Ô∏è',success:'‚úÖ',danger:'üî¥',info:'‚ÑπÔ∏è'};
    body.innerHTML = data.map(n=>`
      <div class="notif-item" style="background:${!n.is_read?'#FAFEF5':'var(--white)'}">
        <div class="notif-icon ${n.notif_type}">${icons[n.notif_type]||'üì¢'}</div>
        <div>
          <div class="notif-title">${n.title}</div>
          <div class="notif-desc">${n.message}</div>
          <div class="notif-time">üìÖ ${n.created_at}</div>
        </div>
      </div>`).join('');
  } catch(e) { body.innerHTML='<div style="color:var(--red-flag);padding:20px">Error loading notifications.</div>'; }
}

// ========================================================
//  PROFILE
// ========================================================
async function loadProfile() {
  if(!institutionId) return;
  try {
    const res = await fetch(`${API}/dashboard/?institution_id=${institutionId}`);
    const d = await res.json();
    document.getElementById('profileName').textContent = d.institution_name;
    document.getElementById('profileBody').innerHTML = `
      <div>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
          <div style="width:70px;height:70px;background:var(--navy);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;color:var(--white);font-family:'Rajdhani'">
            ${(d.institution_name||'I')[0]}
          </div>
          <div>
            <div style="font-family:'Rajdhani';font-size:20px;font-weight:700">${d.institution_name}</div>
            <div style="font-size:12px;color:var(--gray-500)">${d.state}</div>
          </div>
        </div>
        <div style="margin-bottom:10px"><div style="font-size:11px;color:var(--gray-500);font-weight:700;letter-spacing:.5px">AICTE ID</div><div>${d.aicte_id||'‚Äî'}</div></div>
        <div style="margin-bottom:10px"><div style="font-size:11px;color:var(--gray-500);font-weight:700;letter-spacing:.5px">STATE</div><div>${d.state||'‚Äî'}</div></div>
        <div style="margin-bottom:10px"><div style="font-size:11px;color:var(--gray-500);font-weight:700;letter-spacing:.5px">SECTIONS UPLOADED</div><div>${(d.sections_uploaded||[]).join(', ')||'None yet'}</div></div>
      </div>
      <div>
        <div style="margin-bottom:10px"><div style="font-size:11px;color:var(--gray-500);font-weight:700;letter-spacing:.5px">TOTAL STUDENTS</div><div>${d.inst_data?.total_students||'‚Äî'}</div></div>
        <div style="margin-bottom:10px"><div style="font-size:11px;color:var(--gray-500);font-weight:700;letter-spacing:.5px">TOTAL FACULTY</div><div>${d.inst_data?.total_faculty||'‚Äî'}</div></div>
        <div style="margin-bottom:10px"><div style="font-size:11px;color:var(--gray-500);font-weight:700;letter-spacing:.5px">TOTAL LABS</div><div>${d.inst_data?.total_labs||'‚Äî'}</div></div>
        <div style="margin-bottom:10px"><div style="font-size:11px;color:var(--gray-500);font-weight:700;letter-spacing:.5px">NAAC GRADE</div><div>${d.inst_data?.naac_grade||'‚Äî'}</div></div>
        <div style="margin-bottom:10px"><div style="font-size:11px;color:var(--gray-500);font-weight:700;letter-spacing:.5px">RISK SCORE</div>
          <div style="font-family:'Rajdhani';font-size:24px;font-weight:700;color:${d.risk_score>=70?'var(--red-flag)':d.risk_score>=40?'var(--amber)':'var(--green-india)'}">${d.risk_score||0}/100 ‚Äî ${d.risk_level}</div>
        </div>
      </div>
    `;
  } catch(e) {}
}

// ========================================================
//  AUTHORITY
// ========================================================
async function loadAuthorityData() {
  try {
    const [statsRes, instRes] = await Promise.all([
      fetch(`${API}/authority/stats/`),
      fetch(`${API}/authority/all/`)
    ]);
    const stats = await statsRes.json();
    const insts = await instRes.json();
    allInstitutions = insts;

    // Stats cards
    document.getElementById('ath-total').textContent = stats.total_institutions||0;
    document.getElementById('ath-uploads').textContent = stats.total_uploads||0;
    document.getElementById('ath-analyzed').textContent = stats.analyzed||0;
    document.getElementById('ath-high').textContent = stats.high_risk||0;
    document.getElementById('ath-medium').textContent = stats.medium_risk||0;
    document.getElementById('ath-low').textContent = stats.low_risk||0;

    // Charts
    setTimeout(() => buildAuthCharts(stats, insts), 100);

    // High risk table
    const high = insts.filter(i => i.risk_level === 'High');
    const highEl = document.getElementById('authHighRiskBody');
    if(!high.length) {
      highEl.innerHTML='<div style="color:var(--gray-500);padding:20px;text-align:center">No high-risk institutions found.</div>';
    } else {
      highEl.innerHTML = `
        <table class="data-table">
          <thead><tr><th>Institution</th><th>State</th><th>Students</th><th>Faculty</th><th>Risk Score</th><th>Top Risk Factor</th></tr></thead>
          <tbody>${high.map(i=>`<tr>
            <td><b>${i.institution_name}</b><br><small style="color:var(--gray-500)">${i.aicte_id}</small></td>
            <td>${i.state}</td><td>${i.total_students||'‚Äî'}</td><td>${i.total_faculty||'‚Äî'}</td>
            <td><span class="badge badge-high">${i.risk_score}/100</span></td>
            <td style="font-size:12px;color:var(--gray-700)">${(i.risk_factors||[])[0]||'‚Äî'}</td>
          </tr>`).join('')}</tbody>
        </table>`;
    }
  } catch(e) { console.error('Authority load error:', e); }
}

function renderAuthInstitutions() {
  const body = document.getElementById('authInstBody');
  const search = document.getElementById('authSearch').value.toLowerCase();
  const riskFilter = document.getElementById('authRiskFilter').value;
  let filtered = allInstitutions.filter(i => {
    const matchSearch = !search || i.institution_name.toLowerCase().includes(search) || (i.state||'').toLowerCase().includes(search);
    const matchRisk = !riskFilter || i.risk_level === riskFilter;
    return matchSearch && matchRisk;
  });
  document.getElementById('authInstCount').textContent = filtered.length + ' Institutions';
  if(!filtered.length) {
    body.innerHTML='<div style="color:var(--gray-500);text-align:center;padding:32px">No institutions found.</div>';
    return;
  }
  body.innerHTML = `
    <table class="data-table">
      <thead><tr><th>Institution</th><th>State</th><th>Type</th><th>Students</th><th>Faculty</th><th>Labs</th><th>Risk</th><th>Score</th></tr></thead>
      <tbody>${filtered.map(i=>`<tr>
        <td><b>${i.institution_name}</b><br><small style="color:var(--gray-500)">${i.aicte_id||'‚Äî'}</small></td>
        <td>${i.state}</td><td>${i.inst_type}</td>
        <td>${i.total_students||'‚Äî'}</td><td>${i.total_faculty||'‚Äî'}</td><td>${i.total_labs||'‚Äî'}</td>
        <td><span class="badge badge-${(i.risk_level||'pending').toLowerCase().replace(' ','-')}">${i.risk_level||'Not Analyzed'}</span></td>
        <td><b style="font-family:'Rajdhani';font-size:18px;color:${i.risk_score>=70?'var(--red-flag)':i.risk_score>=40?'var(--amber)':'var(--green-india)'}">${i.risk_score||0}</b></td>
      </tr>`).join('')}</tbody>
    </table>`;
}

function filterAuthTable() { renderAuthInstitutions(); }

function renderAuthAnalytics() {
  const insts = allInstitutions;
  const byState = {};
  const byRisk = {Low:0,Medium:0,High:0,'Not Analyzed':0};
  insts.forEach(i => {
    byState[i.state] = (byState[i.state]||0) + 1;
    byRisk[i.risk_level] = (byRisk[i.risk_level]||0) + 1;
  });
  setTimeout(() => {
    makeChart('analyticsRiskChart',{
      type:'doughnut',
      data:{labels:Object.keys(byRisk),datasets:[{data:Object.values(byRisk),backgroundColor:['#138808','#E8920A','#D92B3A','#7A8BA3'],borderWidth:2}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}
    });
    makeChart('analyticsStateChart',{
      type:'bar',
      data:{labels:Object.keys(byState),datasets:[{label:'Institutions',data:Object.values(byState),backgroundColor:'#FF6B00'}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
    });
  }, 100);
}

function buildAuthCharts(stats, insts) {
  const byState = {};
  insts.forEach(i => { byState[i.state]=(byState[i.state]||0)+1; });

  makeChart('riskDistChart',{
    type:'pie',
    data:{labels:['Low Risk','Medium Risk','High Risk'],
      datasets:[{data:[stats.low_risk||0,stats.medium_risk||0,stats.high_risk||0],backgroundColor:['#138808','#E8920A','#D92B3A']}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}
  });
  makeChart('stateChart',{
    type:'bar',
    data:{labels:Object.keys(byState),datasets:[{label:'Institutions',data:Object.values(byState),backgroundColor:'#0a2240'}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
  });
}

// ========================================================
//  CHART HELPER
// ========================================================
function makeChart(id, config) {
  if(chartInstances[id]) chartInstances[id].destroy();
  const el = document.getElementById(id);
  if(!el) return;
  chartInstances[id] = new Chart(el, config);
}

// ========================================================
//  UTILS
// ========================================================
function showErr(el, msg) {
  el.style.display='flex'; el.textContent='‚ùå '+msg;
}

function showToast(msg, color) {
  const div = document.createElement('div');
  const bg = color==='green'?'#138808':'#D92B3A';
  div.style.cssText=`position:fixed;top:72px;right:20px;background:${bg};color:#fff;padding:14px 20px;border-radius:6px;font-size:13px;font-weight:600;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.3);max-width:360px;animation:slideIn .3s ease`;
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(), 4000);
}
</script>
</body>
</html>
